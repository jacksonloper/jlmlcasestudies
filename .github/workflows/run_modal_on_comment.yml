name: Run Modal Scripts on Comment

'on':
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-modal:
    # Only run on PR comments from repo owner with /runmodal command
    if: |
      github.event.issue.pull_request &&
      github.event.comment.body == '/runmodal' &&
      github.event.comment.author_association == 'OWNER'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get PR branch name
        id: get-branch
        run: |
          # Get the PR details to find the head branch
          pr_data=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          branch_name=$(echo "$pr_data" | jq -r .head.ref)
          echo "branch=$branch_name" >> $GITHUB_OUTPUT
          echo "Branch name: $branch_name"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Modal
        run: |
          pip install modal
      
      - name: Configure Modal Token
        env:
          MODAL_TOKEN_COMMAND: ${{ secrets.MODAL_TOKEN_COMMAND }}
        run: |
          eval "$MODAL_TOKEN_COMMAND"
      
      - name: Find changed modal scripts
        id: find-scripts
        run: |
          # Fetch main branch
          git fetch origin main:main
          
          # Find all modal_*.py files that differ from main
          echo "Finding modal_*.py files that differ from main..."
          
          # Get list of all modal_*.py files in current branch
          modal_scripts=$(find . -name "modal_*.py" -type f)
          
          changed_scripts=""
          for script in $modal_scripts; do
            # Check if file exists in main and differs
            if git diff main HEAD -- "$script" | grep -q .; then
              echo "Changed: $script"
              changed_scripts="$changed_scripts $script"
            elif ! git cat-file -e main:"$script" 2>/dev/null; then
              echo "New file: $script"
              changed_scripts="$changed_scripts $script"
            fi
          done
          
          # Save to output
          echo "scripts=$changed_scripts" >> $GITHUB_OUTPUT
          
          if [ -z "$changed_scripts" ]; then
            echo "No changed modal scripts found"
            echo "has_scripts=false" >> $GITHUB_OUTPUT
          else
            echo "Found changed scripts: $changed_scripts"
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Modal scripts
        if: steps.find-scripts.outputs.has_scripts == 'true'
        id: run-scripts
        run: |
          mkdir -p /tmp/modal_results
          
          scripts="${{ steps.find-scripts.outputs.scripts }}"
          
          for script in $scripts; do
            echo "Running: $script"
            script_name=$(basename "$script" .py)
            script_dir=$(dirname "$script")
            
            cd "$script_dir"
            
            # Run the modal script with 30 minute duration
            if modal run "$(basename $script)" --duration-minutes 30 2>&1 | tee "/tmp/modal_results/${script_name}.log"; then
              echo "âœ“ $script completed successfully"
              
              # Copy outputs to temp for artifacts
              if [ -d "modal_outputs" ]; then
                cp -r modal_outputs "/tmp/modal_results/${script_name}_outputs"
                
                # Move outputs to data directory, creating it if needed
                # Determine the case directory (parent of scripts dir)
                case_dir=$(dirname "$script_dir")
                data_dir="$case_dir/data"
                
                # Create data directory if it doesn't exist
                if [ ! -d "$data_dir" ]; then
                  echo "Creating data directory at $data_dir/"
                  mkdir -p "$data_dir"
                fi
                
                echo "Moving outputs from modal_outputs/ to $data_dir/"
                # Move all files from modal_outputs to data directory
                # Use shopt to enable dotglob to include hidden files
                shopt -s nullglob dotglob
                files=(modal_outputs/*)
                if [ ${#files[@]} -gt 0 ]; then
                  mv modal_outputs/* "$data_dir/"
                  echo "âœ“ Outputs moved to $data_dir/"
                else
                  echo "âš  No files found in modal_outputs/"
                fi
                # Remove the modal_outputs directory (using -rf to handle any edge cases)
                rm -rf modal_outputs
              fi
            else
              echo "âœ— $script failed"
            fi
            
            cd - > /dev/null
          done
      
      - name: Commit and push data files
        if: steps.find-scripts.outputs.has_scripts == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all data directory changes (CSV, PNG, NPY, JSON files)
          # Limit search to case* and dataset* directories to improve performance
          find . \( -path './case*/data/*' -o -path './dataset*/data/*' \) \( -name '*.csv' -o -name '*.png' -o -name '*.npy' -o -name '*.json' \) -type f -exec git add -f {} \;
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Committing data files..."
            git commit -m "Add data and plots from /runmodal command"
            
            echo "Pushing to PR branch: ${{ steps.get-branch.outputs.branch }}"
            git push origin HEAD:${{ steps.get-branch.outputs.branch }}
          fi
      
      - name: Upload results as artifacts
        if: steps.find-scripts.outputs.has_scripts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: modal-results-${{ github.event.issue.number }}
          path: /tmp/modal_results/
          retention-days: 3
      
      - name: Prepare comment with results
        if: steps.find-scripts.outputs.has_scripts == 'true'
        id: prepare-comment
        run: |
          # Create comment body
          cat << 'EOF' > /tmp/comment_body.md
          ## Modal Scripts Results
          
          Ran Modal scripts in response to `/runmodal` command.
          
          ### Scripts Executed
          
          EOF
          
          scripts="${{ steps.find-scripts.outputs.scripts }}"
          
          for script in $scripts; do
            script_name=$(basename "$script" .py)
            echo "- \`$script\`" >> /tmp/comment_body.md
            
            # Add plots if they exist
            output_dir="/tmp/modal_results/${script_name}_outputs"
            if [ -d "$output_dir" ]; then
              echo "" >> /tmp/comment_body.md
              echo "#### Results for \`$script\`" >> /tmp/comment_body.md
              echo "" >> /tmp/comment_body.md
              
              # List key outputs
              if [ -f "$output_dir/training_loss.csv" ]; then
                echo "âœ“ Training loss data generated" >> /tmp/comment_body.md
              fi
              if [ -f "$output_dir/energy_score.csv" ]; then
                echo "âœ“ Energy score data generated" >> /tmp/comment_body.md
              fi
              if [ -f "$output_dir/scatter_samples.csv" ]; then
                samples=$(wc -l < "$output_dir/scatter_samples.csv")
                echo "âœ“ Generated $samples scatter samples" >> /tmp/comment_body.md
              fi
              
              echo "" >> /tmp/comment_body.md
              echo "ðŸ“Š **Plots and data files have been moved to the data directory and committed:**" >> /tmp/comment_body.md
              echo "- training_loss.png" >> /tmp/comment_body.md
              echo "- training_loss.csv" >> /tmp/comment_body.md
              echo "- energy_score.png" >> /tmp/comment_body.md
              echo "- energy_score.csv" >> /tmp/comment_body.md
              echo "- scatter_plot.png" >> /tmp/comment_body.md
              echo "- scatter_samples.csv" >> /tmp/comment_body.md
              echo "- training_plots.png (combined)" >> /tmp/comment_body.md
            fi
            
            echo "" >> /tmp/comment_body.md
          done
          
          cat << 'EOF' >> /tmp/comment_body.md
          
          ### Committed Files
          
          All generated CSV and PNG files have been moved to the corresponding data directories and committed to this PR branch.
          
          EOF
          
          # Save comment body
          cat /tmp/comment_body.md
      
      - name: Post comment to PR
        if: steps.find-scripts.outputs.has_scripts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('/tmp/comment_body.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      
      - name: Post no scripts message
        if: steps.find-scripts.outputs.has_scripts == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Modal Scripts Results\n\nNo `modal_*.py` scripts found that differ from main branch.'
            });
