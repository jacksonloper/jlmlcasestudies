name: Run Modal Scripts on Comment

'on':
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-modal:
    # Only run on PR comments from repo owner with /runmodal command
    if: |
      github.event.issue.pull_request &&
      github.event.comment.body == '/runmodal' &&
      github.event.comment.author_association == 'OWNER'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get PR branch name
        id: get-branch
        run: |
          # Get the PR details to find the head branch
          pr_data=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          branch_name=$(echo "$pr_data" | jq -r .head.ref)
          echo "branch=$branch_name" >> $GITHUB_OUTPUT
          echo "Branch name: $branch_name"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Modal
        run: |
          pip install modal
      
      - name: Configure Modal Token
        env:
          MODAL_TOKEN_COMMAND: ${{ secrets.MODAL_TOKEN_COMMAND }}
        run: |
          eval "$MODAL_TOKEN_COMMAND"
      
      - name: Find changed modal scripts
        id: find-scripts
        run: |
          # Fetch main branch
          git fetch origin main:main
          
          # Find all modal_*.py files that differ from main
          echo "Finding modal_*.py files that differ from main..."
          
          # Get list of all modal_*.py files in current branch
          modal_scripts=$(find . -name "modal_*.py" -type f)
          
          changed_scripts=""
          for script in $modal_scripts; do
            # Check if file exists in main and differs
            if git diff main HEAD -- "$script" | grep -q .; then
              echo "Changed: $script"
              changed_scripts="$changed_scripts $script"
            elif ! git cat-file -e main:"$script" 2>/dev/null; then
              echo "New file: $script"
              changed_scripts="$changed_scripts $script"
            fi
          done
          
          # Save to output
          echo "scripts=$changed_scripts" >> $GITHUB_OUTPUT
          
          if [ -z "$changed_scripts" ]; then
            echo "No changed modal scripts found"
            echo "has_scripts=false" >> $GITHUB_OUTPUT
          else
            echo "Found changed scripts: $changed_scripts"
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Determine which workflows to trigger
        if: steps.find-scripts.outputs.has_scripts == 'true'
        id: determine-workflows
        run: |
          scripts="${{ steps.find-scripts.outputs.scripts }}"
          
          # Map script names to workflow names
          declare -A script_to_workflow
          script_to_workflow["modal_train_infinitedata_jax.py"]="run_modal_train_infinitedata_jax.yml"
          
          workflows_to_trigger=""
          
          for script in $scripts; do
            script_name=$(basename "$script")
            
            if [[ -v script_to_workflow[$script_name] ]]; then
              workflow="${script_to_workflow[$script_name]}"
              workflows_to_trigger="$workflows_to_trigger $workflow"
              echo "✓ Found workflow for $script_name: $workflow"
            else
              echo "⚠ No workflow found for $script_name"
            fi
          done
          
          echo "workflows=$workflows_to_trigger" >> $GITHUB_OUTPUT
          
          if [ -z "$workflows_to_trigger" ]; then
            echo "has_workflows=false" >> $GITHUB_OUTPUT
          else
            echo "has_workflows=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger modal_train_infinitedata_jax workflow
        if: steps.find-scripts.outputs.has_scripts == 'true' && contains(steps.determine-workflows.outputs.workflows, 'run_modal_train_infinitedata_jax.yml')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'run_modal_train_infinitedata_jax.yml',
              ref: '${{ steps.get-branch.outputs.branch }}',
              inputs: {
                duration_minutes: '5',
                pr_number: '${{ github.event.issue.number }}',
                branch_name: '${{ steps.get-branch.outputs.branch }}'
              }
            });
      
      - name: Post workflow triggered comment
        if: steps.determine-workflows.outputs.has_workflows == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = '${{ steps.determine-workflows.outputs.workflows }}'.trim().split(/\s+/);
            
            let body = '## Modal Scripts Workflows Triggered\n\n';
            body += 'The following workflows have been triggered to run the changed modal scripts:\n\n';
            
            for (const workflow of workflows) {
              body += `- \`${workflow}\`\n`;
            }
            
            body += '\n';
            body += 'You can monitor their progress in the [Actions tab](https://github.com/${{ github.repository }}/actions).\n';
            body += '\n';
            body += 'Each workflow will post its own status comment when complete.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Post no scripts or workflows message
        if: steps.find-scripts.outputs.has_scripts == 'false' || steps.determine-workflows.outputs.has_workflows == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            let body = '## Modal Scripts Results\n\n';
            
            if ('${{ steps.find-scripts.outputs.has_scripts }}' === 'false') {
              body += 'No `modal_*.py` scripts found that differ from main branch.';
            } else if ('${{ steps.determine-workflows.outputs.has_workflows }}' === 'false') {
              body += 'Changed modal scripts were found, but no corresponding workflows exist for them.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
