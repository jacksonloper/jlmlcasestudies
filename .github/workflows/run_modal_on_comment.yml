name: Run Modal Scripts on Comment

'on':
  issue_comment:
    types: [created]

# Add concurrency guard to prevent duplicate runs from repeated comments
concurrency:
  group: run-modal-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  find-scripts:
    # Allow OWNER, MEMBER, and COLLABORATOR to trigger
    if: |
      github.event.issue.pull_request &&
      github.event.comment.body == '/runmodal' &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    runs-on: ubuntu-latest
    outputs:
      scripts: ${{ steps.find.outputs.scripts }}
      has_scripts: ${{ steps.find.outputs.has_scripts }}

    steps:
      - name: Get PR details and checkout
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // For fork PRs, use the SHA directly instead of branch name
            // This avoids issues with refs not existing in base repo
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('base_sha', pr.data.base.sha);
            core.setOutput('is_fork', pr.data.head.repo.full_name !== pr.data.base.repo.full_name);

            return pr.data;

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.sha }}
          fetch-depth: 0

      - name: Find changed modal scripts
        id: find
        run: |
          # Fetch base branch for comparison
          git fetch origin ${{ steps.pr-info.outputs.base_sha }}

          # Use git diff to find modified/added modal_*.py files
          # This is simpler and handles new/modified files correctly
          changed_files=$(git diff --name-only --diff-filter=AM ${{ steps.pr-info.outputs.base_sha }}..HEAD -- '**/modal_*.py' || echo "")

          if [ -z "$changed_files" ]; then
            echo "No changed modal scripts found"
            echo "has_scripts=false" >> $GITHUB_OUTPUT
            echo "scripts=[]" >> $GITHUB_OUTPUT
          else
            echo "Found changed scripts:"
            echo "$changed_files"

            # Convert to JSON array for matrix strategy
            scripts_json=$(echo "$changed_files" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "scripts=$scripts_json" >> $GITHUB_OUTPUT
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          fi

      - name: Post no scripts message
        if: steps.find.outputs.has_scripts == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Modal Scripts Results\n\nNo `modal_*.py` scripts found that differ from the base branch.'
            });

  run-scripts:
    needs: find-scripts
    if: needs.find-scripts.outputs.has_scripts == 'true'
    strategy:
      matrix:
        script: ${{ fromJson(needs.find-scripts.outputs.scripts) }}
      fail-fast: false
      max-parallel: 3
    uses: ./.github/workflows/run_modal_script.yml
    with:
      script_path: ${{ matrix.script }}
      duration_minutes: ''
      pr_number: ${{ github.event.issue.number }}
    secrets: inherit

  post-summary:
    needs: [find-scripts, run-scripts]
    if: always() && needs.find-scripts.outputs.has_scripts == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const scripts = ${{ needs.find-scripts.outputs.scripts }};
            const runScriptsResult = '${{ needs.run-scripts.result }}';

            let body = '## Modal Scripts Execution Complete\n\n';
            body += `Executed ${scripts.length} script(s) with status: **${runScriptsResult}**\n\n`;
            body += '### Scripts:\n';

            for (const script of scripts) {
              body += `- \`${script}\`\n`;
            }

            body += '\n';
            body += `View detailed results in the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
