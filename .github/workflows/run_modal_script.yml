name: Run Modal Script

'on':
  workflow_dispatch:
    inputs:
      script_path:
        description: 'Path to the modal script (e.g., case2/scripts/modal_train_infinitedata_jax.py)'
        required: true
        type: string
      duration_minutes:
        description: 'Training duration in minutes (if applicable)'
        required: false
        default: ''
        type: string
      pr_number:
        description: 'PR number (leave empty for manual runs)'
        required: false
        type: string
  workflow_call:
    inputs:
      script_path:
        description: 'Path to the modal script'
        required: true
        type: string
      duration_minutes:
        description: 'Training duration in minutes (if applicable)'
        required: false
        default: ''
        type: string
      pr_number:
        description: 'PR number for commenting'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    # Add timeout to prevent long-running jobs from stacking up
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal and dependencies
        run: |
          pip install modal numpy

      - name: Configure Modal Token
        env:
          MODAL_TOKEN_COMMAND: ${{ secrets.MODAL_TOKEN_COMMAND }}
        run: |
          eval "$MODAL_TOKEN_COMMAND"

      - name: Run modal script
        id: run-script
        run: |
          set -o pipefail

          script_path="${{ inputs.script_path }}"
          script_name=$(basename "$script_path")
          script_dir=$(dirname "$script_path")

          echo "Running: $script_path"
          echo "Script name: $script_name"
          echo "Script directory: $script_dir"

          cd "$script_dir"

          # Run the modal script with duration parameter only if provided
          if [ -n "${{ inputs.duration_minutes }}" ]; then
            echo "Running with duration: ${{ inputs.duration_minutes }} minutes"
            if modal run "$script_name" --duration-minutes ${{ inputs.duration_minutes }} 2>&1 | tee /tmp/modal_run.log; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "✓ Script completed successfully"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "✗ Script failed"
              exit 1
            fi
          else
            echo "Running with default duration"
            if modal run "$script_name" 2>&1 | tee /tmp/modal_run.log; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "✓ Script completed successfully"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "✗ Script failed"
              exit 1
            fi
          fi

      - name: Move outputs to data directory
        if: steps.run-script.outputs.success == 'true'
        run: |
          script_path="${{ inputs.script_path }}"
          script_dir=$(dirname "$script_path")

          cd "$script_dir"

          if [ -d "modal_outputs" ]; then
            # Determine the case/dataset directory (parent of scripts dir)
            parent_dir=$(dirname "$script_dir")
            data_dir="$parent_dir/data"

            # Create data directory if it doesn't exist
            if [ ! -d "$data_dir" ]; then
              echo "Creating data directory at $data_dir/"
              mkdir -p "$data_dir"
            fi

            echo "Moving outputs from modal_outputs/ to $data_dir/"
            shopt -s nullglob dotglob
            files=(modal_outputs/*)
            if [ ${#files[@]} -gt 0 ]; then
              mv modal_outputs/* "$data_dir/"
              echo "✓ Outputs moved to $data_dir/"
            else
              echo "⚠ No files found in modal_outputs/"
            fi
            rm -rf modal_outputs
          fi

      - name: Get PR branch info
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != ''
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number }}
            });
            const isFork = pr.data.head.repo.full_name !== pr.data.base.repo.full_name;
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('is_fork', isFork.toString());

      - name: Commit data files to PR branch
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-info.outputs.is_fork != 'true'
        run: |
          script_path="${{ inputs.script_path }}"
          script_dir=$(dirname "$script_path")
          parent_dir=$(dirname "$script_dir")
          data_dir="$parent_dir/data"

          # Check if there are any data files to commit
          if [ -d "$data_dir" ] && [ "$(ls -A "$data_dir" 2>/dev/null)" ]; then
            echo "Found data files in $data_dir"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Fetch and checkout the PR branch
            git fetch origin ${{ steps.pr-info.outputs.branch }}
            git checkout ${{ steps.pr-info.outputs.branch }}

            # Add the data files
            git add "$data_dir"

            # Commit if there are changes
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Add modal script outputs for ${{ inputs.script_path }}"
              git push origin ${{ steps.pr-info.outputs.branch }}
              echo "✓ Data files committed to PR branch"
            fi
          else
            echo "No data files found to commit"
          fi

      - name: Skip commit for fork PRs
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-info.outputs.is_fork == 'true'
        run: |
          echo "⚠ Skipping commit: Cannot push to fork PR branches due to permission restrictions."
          echo "Data files were generated but must be committed manually."

      - name: Post success comment to PR
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-info.outputs.is_fork != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **${{ inputs.script_path }}** completed successfully! Data files have been committed to this PR branch.'
            });

      - name: Post success comment to fork PR
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-info.outputs.is_fork == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **${{ inputs.script_path }}** completed successfully!\n\n⚠️ Note: This is a fork PR, so data files could not be automatically committed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for the generated outputs.'
            });

      - name: Post failure comment to PR
        if: steps.run-script.outputs.success == 'false' && inputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **${{ inputs.script_path }}** failed!\n\nCheck the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            });

      - name: Display results summary
        if: always()
        run: |
          echo "## Modal Script Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-script.outputs.success }}" == "true" ]; then
            echo "✅ Script completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Script failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Script**: \`${{ inputs.script_path }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.duration_minutes }}" ]; then
            echo "**Duration**: ${{ inputs.duration_minutes }} minutes" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Duration**: Using script default" >> $GITHUB_STEP_SUMMARY
          fi
