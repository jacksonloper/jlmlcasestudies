name: Run Modal Script

'on':
  workflow_dispatch:
    inputs:
      script_path:
        description: 'Path to the modal script (e.g., case2/scripts/modal_train_infinitedata_jax.py)'
        required: true
        type: string
      duration_minutes:
        description: 'Training duration in minutes (if applicable)'
        required: false
        default: ''
        type: string
      pr_number:
        description: 'PR number (leave empty for manual runs)'
        required: false
        type: string
  workflow_call:
    inputs:
      script_path:
        description: 'Path to the modal script'
        required: true
        type: string
      duration_minutes:
        description: 'Training duration in minutes (if applicable)'
        required: false
        default: ''
        type: string
      pr_number:
        description: 'PR number for commenting'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    # Add timeout to prevent long-running jobs from stacking up
    timeout-minutes: 45

    steps:
      - name: Get PR branch info
        if: inputs.pr_number != ''
        id: pr-checkout-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number }}
            });
            const isFork = pr.data.head.repo.full_name !== pr.data.base.repo.full_name;
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('is_fork', isFork.toString());

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ (inputs.pr_number != '' && steps.pr-checkout-info.outputs.is_fork != 'true' && steps.pr-checkout-info.outputs.branch) || (inputs.pr_number != '' && steps.pr-checkout-info.outputs.sha) || '' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal and dependencies
        run: |
          pip install modal numpy

      - name: Configure Modal Token
        env:
          MODAL_TOKEN_COMMAND: ${{ secrets.MODAL_TOKEN_COMMAND }}
        run: |
          eval "$MODAL_TOKEN_COMMAND"

      - name: Run modal script
        id: run-script
        run: |
          set -o pipefail

          script_path="${{ inputs.script_path }}"
          script_name=$(basename "$script_path")
          script_dir=$(dirname "$script_path")

          echo "Running: $script_path"
          echo "Script name: $script_name"
          echo "Script directory: $script_dir"

          cd "$script_dir"

          # Run the modal script with duration parameter only if provided
          if [ -n "${{ inputs.duration_minutes }}" ]; then
            echo "Running with duration: ${{ inputs.duration_minutes }} minutes"
            if modal run "$script_name" --duration-minutes ${{ inputs.duration_minutes }} 2>&1 | tee /tmp/modal_run.log; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "✓ Script completed successfully"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "✗ Script failed"
              exit 1
            fi
          else
            echo "Running with default duration"
            if modal run "$script_name" 2>&1 | tee /tmp/modal_run.log; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "✓ Script completed successfully"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "✗ Script failed"
              exit 1
            fi
          fi

      - name: Commit data files to PR branch
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-checkout-info.outputs.is_fork != 'true'
        run: |
          script_path="${{ inputs.script_path }}"
          script_dir=$(dirname "$script_path")
          parent_dir=$(dirname "$script_dir")
          data_dir="$parent_dir/data"
          modal_outputs_dir="$script_dir/modal_outputs"

          # Check if there are any modal output files
          if [ -d "$modal_outputs_dir" ] && [ "$(ls -A "$modal_outputs_dir" 2>/dev/null)" ]; then
            echo "Found modal outputs in $modal_outputs_dir"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # We're already on the PR branch (checked out at start)
            # Now move outputs from modal_outputs/ to data directory
            mkdir -p "$data_dir"
            mv "$modal_outputs_dir"/* "$data_dir/"
            rm -rf "$modal_outputs_dir"
            echo "✓ Outputs moved to $data_dir"

            # Add the data files
            git add "$data_dir"

            # Commit if there are changes
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Add modal script outputs for ${{ inputs.script_path }}"
              git push origin ${{ steps.pr-checkout-info.outputs.branch }}
              echo "✓ Data files committed to PR branch"
            fi
          else
            echo "No modal output files found to commit"
          fi

      - name: Move outputs to data directory (non-PR runs)
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number == ''
        run: |
          script_path="${{ inputs.script_path }}"
          script_dir=$(dirname "$script_path")
          parent_dir=$(dirname "$script_dir")
          data_dir="$parent_dir/data"
          modal_outputs_dir="$script_dir/modal_outputs"

          if [ -d "$modal_outputs_dir" ] && [ "$(ls -A "$modal_outputs_dir" 2>/dev/null)" ]; then
            mkdir -p "$data_dir"
            mv "$modal_outputs_dir"/* "$data_dir/"
            rm -rf "$modal_outputs_dir"
            echo "✓ Outputs moved to $data_dir"
          fi

      - name: Skip commit for fork PRs
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-checkout-info.outputs.is_fork == 'true'
        run: |
          echo "⚠ Skipping commit: Cannot push to fork PR branches due to permission restrictions."
          echo "Data files were generated but must be committed manually."

      - name: Post success comment to PR
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-checkout-info.outputs.is_fork != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **${{ inputs.script_path }}** completed successfully! Data files have been committed to this PR branch.'
            });

      - name: Post success comment to fork PR
        if: steps.run-script.outputs.success == 'true' && inputs.pr_number != '' && steps.pr-checkout-info.outputs.is_fork == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **${{ inputs.script_path }}** completed successfully!\n\n⚠️ Note: This is a fork PR, so data files could not be automatically committed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for the generated outputs.'
            });

      - name: Post failure comment to PR
        if: steps.run-script.outputs.success == 'false' && inputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **${{ inputs.script_path }}** failed!\n\nCheck the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            });

      - name: Display results summary
        if: always()
        run: |
          echo "## Modal Script Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-script.outputs.success }}" == "true" ]; then
            echo "✅ Script completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Script failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Script**: \`${{ inputs.script_path }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.duration_minutes }}" ]; then
            echo "**Duration**: ${{ inputs.duration_minutes }} minutes" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Duration**: Using script default" >> $GITHUB_STEP_SUMMARY
          fi
