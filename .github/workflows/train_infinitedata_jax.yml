name: Train Case2 Infinite Data with JAX on Modal

'on':
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'Training duration in minutes'
        required: false
        default: '10'
        type: string

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Modal
        run: |
          pip install modal
      
      - name: Configure Modal Token
        run: |
          ${{ secrets.MODAL_TOKEN_COMMAND }}
      
      - name: Run training on Modal
        run: |
          cd case2/scripts
          modal run train_infinitedata_jax_modal.py --duration-minutes ${{ inputs.duration_minutes }}
      
      - name: Upload training artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: training-results-${{ github.run_id }}
          path: case2/scripts/modal_outputs/
          retention-days: 3
          if-no-files-found: error
      
      - name: Display results summary
        if: always()
        run: |
          echo "## Training Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Training completed. Artifacts have been uploaded." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- training_loss.csv - Training loss over time" >> $GITHUB_STEP_SUMMARY
          echo "- energy_score.csv - Energy score over time" >> $GITHUB_STEP_SUMMARY
          echo "- scatter_samples.csv - 1000 samples from the model" >> $GITHUB_STEP_SUMMARY
          echo "- training_loss.png - Plot of training loss" >> $GITHUB_STEP_SUMMARY
          echo "- energy_score.png - Plot of energy score" >> $GITHUB_STEP_SUMMARY
          echo "- scatter_plot.png - Scatterplot of samples" >> $GITHUB_STEP_SUMMARY
          echo "- training_plots.png - Combined plots" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f case2/scripts/modal_outputs/training_loss.csv ]; then
            echo "### Quick Stats:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -5 case2/scripts/modal_outputs/training_loss.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
